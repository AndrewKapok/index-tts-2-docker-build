# 代理服务核心配置
server {
    listen 80;
    server_name localhost;  # 本地测试用，部署到服务器可替换为实际域名

    # 日志配置（可选，方便调试）
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # 所有请求（页面 + API）均转发到目标 Space
    location / {
        # 目标 Space 的实际后端地址（Hugging Face Spaces 后端域名格式）
        proxy_pass https://andrewkapok-index-tts.hf.space;

        # 关键：传递请求头，确保后端能正确识别请求来源和协议
        proxy_set_header Host andrewkapok-index-tts.hf.space;  # 后端验证的 Host
        proxy_set_header X-Real-IP $remote_addr;                # 客户端真实 IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # 代理链 IP
        proxy_set_header X-Forwarded-Proto $scheme;              # 请求协议（HTTP/HTTPS）
        proxy_set_header Accept-Encoding "";                     # 避免压缩导致的内容乱码

        # 超时设置（适配 TTS 生成可能的长耗时）
        proxy_connect_timeout 5m;    # 连接超时 5 分钟
        proxy_send_timeout 5m;       # 发送超时 5 分钟
        proxy_read_timeout 5m;       # 读取超时 5 分钟

        # 支持 WebSocket（若 Space 有实时交互功能，如语音生成进度更新）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 处理重定向（若后端返回 301/302，自动跟随并调整域名）
        proxy_redirect https://andrewkapok-index-tts.hf.space/ /;
    }

    # 单独匹配 API 路径（增强兼容性，确保 /api/* 接口被正确代理）
    location /api/ {
        proxy_pass https://andrewkapok-index-tts.hf.space/api/;
        # 复用上面的请求头配置（避免重复编写）
        proxy_set_header Host andrewkapok-index-tts.hf.space;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 5m;
        proxy_send_timeout 5m;
        proxy_read_timeout 5m;
    }
}